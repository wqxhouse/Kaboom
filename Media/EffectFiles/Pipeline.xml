<?xml version="1.0" encoding="utf-8"?>

<compositor>
  <include>EffectFiles/template.xml</include>
  <include>EffectFiles/SpecularLutPassConfig.xml</include>
  <include>EffectFiles/GeometryPassConfig.xml</include>
  <include>EffectFiles/LightPrePassConfig.xml</include>
  <include>EffectFiles/LightPassConfig.xml</include>
  <!--<include>EffectFiles/smaa.xml</include>-->

  <shader name="defaultQuad_vs" type="vertex">
    <version>120</version>
    <file>Shaders/defaultQuad.vert</file>
  </shader>

  <uniform name="u_nearPlane" type="float">
    <inbuilt_value>near_plane</inbuilt_value>
  </uniform>
  
  <uniform name="u_farPlane" type="float">
    <inbuilt_value>far_plane</inbuilt_value>
  </uniform>

  <uniform name="u_eyePos" type="vec3">
    <!--<inbuilt_value>eye_position</inbuilt_value>-->
    <value>0 0 0</value>
  </uniform>

  <buffer name="debugDepth" type="2d">
    <internal_format>depth32</internal_format>
    <source_format>depth</source_format>
    <source_type>float</source_type>
  </buffer>

  <technique name="deferred_shading">
    <forward_pass name="PreFilterCubeMapPass" >
      <clear_color>0 0 0 1</clear_color>
      <culling mask="0x8"></culling>
      <near_far preserve="0"/>
    </forward_pass>

    <deferred_pass name="SpecularLutPass" >
      <shader>spec_lut_vs</shader>
      <shader>spec_lut_ps</shader>
      <output_buffer target="color">b_lut</output_buffer>
    </deferred_pass>

    <forward_pass name="GeometryPass">
      <clear_color>0 0 0 1</clear_color>
      <culling mask="0x1"></culling>
      <uniform>u_farPlane</uniform>
      <output_buffer target="color0">b_RT0</output_buffer>
      <output_buffer target="color1">b_RT1</output_buffer>
      <output_buffer target="color2">b_RT2</output_buffer>
      <output_buffer target="depth">debugDepth</output_buffer>
    </forward_pass>

    <forward_pass name="SkyBoxPass">
      <clear_mask>color</clear_mask>
      <culling mask="0x2"></culling>
      <near_far preserve="0"/>
      <output_buffer>b_shading</output_buffer>
    </forward_pass>

    <deferred_pass name="LightPrePass">
      <input_buffer unit="0" varname="o_destination">b_PerTileStorage</input_buffer>
      <!--<input_buffer unit="1" varname="u_normalDepthTex">b_RT2</input_buffer>-->
      <input_buffer unit="1" varname="u_normalDepthTex">debugDepth</input_buffer>
      <output_buffer target="color">b_computeShaderTrigger</output_buffer>

      <clear_mask>color</clear_mask>
      
      <uniform_buffer>u_lightsBuffer</uniform_buffer>
      <uniform>u_countPointLight</uniform>
      <uniform>u_countDirectionalLight</uniform>
      <uniform>u_arrayDirectionalLight</uniform>
      <uniform>u_arrayPointLight</uniform>

      <!--<uniform>u_viewMat</uniform>-->
      <uniform>u_projMat</uniform>
      <!--<uniform>u_viewProjMat</uniform>-->

      <uniform>u_nearPlane</uniform>
      <uniform>u_farPlane</uniform>

      <shader>defaultQuad_vs</shader>
      <shader>computeLightTile_fs</shader>
    </deferred_pass>
    
    <deferred_pass name="LightPass">
      <input_buffer unit="0" varname="u_lightsBuffer">b_PerTileStorage</input_buffer>
      <input_buffer unit="1" varname="u_RT0">b_RT0</input_buffer>
      <input_buffer unit="2" varname="u_RT1">b_RT1</input_buffer>
      <input_buffer unit="3" varname="u_RT2">b_RT2</input_buffer>
      <!--<input_buffer unit="4" varname="u_cubeMapTex">b_cubemap</input_buffer>-->
      <!-- 5 is the lut -->

      <clear_mask>depth</clear_mask>
      <output_buffer target="color">b_shading</output_buffer>

      <uniform_buffer>u_lightsBuffer</uniform_buffer>
      <uniform>u_viewInvMat</uniform>
      <uniform>u_projInvMat</uniform>
      <uniform>u_farPlane</uniform>
      <!--<uniform>u_eyePos</uniform>-->
      <uniform>u_maxLodLevel</uniform>

      <shader>lightPass_vs</shader>
      <shader>lightPass_fs</shader>
    </deferred_pass>

    <forward_pass name="ManipulatorPass">
      <clear_mask>0</clear_mask>
      <output_buffer target="depth">debugDepth</output_buffer>
      <culling mask="0x4"></culling>
      <near_far preserve="0" />
      <output_buffer>b_shading</output_buffer>
    </forward_pass>

    <forward_pass name="ParticleEffectPass">
      <clear_mask>0</clear_mask>
      <culling mask="0x10"></culling>
      <near_far preserve="0" />
      <!-- TODO: make sure depth write is disabled -->
      <output_buffer target="depth">debugDepth</output_buffer>
      <output_buffer>b_shading</output_buffer>
    </forward_pass>

    <!-- SMAA -->
    <!--<deferred_pass name="SMAA_EdgeDetection">
      <input_buffer unit="0" varname="sceneTex">b_shading</input_buffer>
      <output_buffer target="color">smaaEdgeResult</output_buffer>
      <shader>smaa_edge_vs</shader>
      <shader>smaa_edge_ps</shader>
    </deferred_pass>

    <deferred_pass name="SMAA_Blend">
      <input_buffer unit="0" varname="edgeTex">smaaEdgeResult</input_buffer>
      <texture unit="1" varname="areaTex">smaaAreaTex</texture>
      <texture unit="2" varname="searchTex">smaaSearchTex</texture>
      <output_buffer target="color">smaaBlendResult</output_buffer>
      <shader>smaa_blend_vs</shader>
      <shader>smaa_blend_ps</shader>
    </deferred_pass>

    <deferred_pass name="SMAA_Final">
      <input_buffer unit="0" varname="sceneTex">b_shading</input_buffer>
      <input_buffer unit="1" varname="smaaTex">smaaBlendResult</input_buffer>
      <shader>smaa_neighborhood_vs</shader>
      <shader>smaa_neighborhood_ps</shader>
    </deferred_pass>-->

    <deferred_pass name="FinalPass">
      <input_buffer unit="0">b_shading</input_buffer>
    </deferred_pass>
  </technique>

</compositor>