<?xml version="1.0" encoding="utf-8"?>

<compositor>
  <include>EffectFiles/template.xml</include>
  <include>EffectFiles/GeometryPassConfig.xml</include>
  <include>EffectFiles/LightPrePassConfig.xml</include>
  <include>EffectFiles/LightPassConfig.xml</include>

  <shader name="defaultQuad_vs" type="vertex">
    <version>120</version>
    <file>Shaders/defaultQuad.vert</file>
  </shader>

  <uniform name="u_nearPlane" type="float">
    <inbuilt_value>near_plane</inbuilt_value>
  </uniform>
  
  <uniform name="u_farPlane" type="float">
    <inbuilt_value>far_plane</inbuilt_value>
  </uniform>

  <uniform name="u_eyePos" type="vec3">
    <!--<inbuilt_value>eye_position</inbuilt_value>-->
    <value>0 0 0</value>
  </uniform>

  <!--<technique name="skybox_rendering">
    <forward_pass name="skybox_pass">
      <output_buffer target="color">b_shading</output_buffer>
    </forward_pass>
  </technique>-->

  <technique name="deferred_shading">
    <forward_pass name="GeometryPass">
      <clear_color>0 0 0 1</clear_color>
      <culling mask="0x1"></culling>
      <uniform>u_farPlane</uniform>
      <output_buffer target="color0">b_RT0</output_buffer>
      <output_buffer target="color1">b_RT1</output_buffer>
      <output_buffer target="color2">b_RT2</output_buffer>
    </forward_pass>

    <!--<forward_pass name="SkyBoxPass">
      <clear_mask>color depth</clear_mask>
      <culling mask="0x2"></culling>
      <output_buffer>b_shading</output_buffer>
    </forward_pass>-->

    <deferred_pass name="LightPrePass">
      <input_buffer unit="0" varname="o_destination">b_PerTileStorage</input_buffer>
      <input_buffer unit="1" varname="u_normalDepthTex">b_RT2</input_buffer>
      <output_buffer target="color">b_computeShaderTrigger</output_buffer>
      
      <uniform_buffer>u_lightsBuffer</uniform_buffer>
      <uniform>u_countPointLight</uniform>
      <uniform>u_countDirectionalLight</uniform>
      <uniform>u_arrayDirectionalLight</uniform>
      <uniform>u_arrayPointLight</uniform>

      <uniform>u_viewMat</uniform>
      <uniform>u_projMat</uniform>
      <uniform>u_viewProjMat</uniform>

      <uniform>u_nearPlane</uniform>
      <uniform>u_farPlane</uniform>

      <shader>defaultQuad_vs</shader>
      <shader>computeLightTile_fs</shader>
    </deferred_pass>
    
    <deferred_pass name="LightPass">
      <input_buffer unit="0" varname="u_lightsBuffer">b_PerTileStorage</input_buffer>
      <input_buffer unit="1" varname="u_RT0">b_RT0</input_buffer>
      <input_buffer unit="2" varname="u_RT1">b_RT1</input_buffer>
      <input_buffer unit="3" varname="u_RT2">b_RT2</input_buffer>

      <!--<clear_mask>depth</clear_mask>-->
      <output_buffer target="color">b_shading</output_buffer>

      <uniform_buffer>u_lightsBuffer</uniform_buffer>
      <uniform>u_projInvMat</uniform>
      <uniform>u_farPlane</uniform>
      <uniform>u_eyePos</uniform>

      <shader>lightPass_vs</shader>
      <shader>lightPass_fs</shader>
    </deferred_pass>

    <deferred_pass name="FinalPass">
      <input_buffer unit="0">b_shading</input_buffer>
    </deferred_pass>
  </technique>

</compositor>